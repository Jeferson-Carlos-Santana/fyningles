{% load static %}
<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="{% static 'chat/css/style.css' %}">
    <meta charset="utf-8">
    <title>chat</title>
</head>
<body>

        <div class="layout">
            <nav class="sidebar">
                <div class="sidebar-inner">
                    <div class="bar-1">
                        <ul class="menu">
                            <div class="infor">ğŸ‘¤ Jeferson carlos Santana</div>
                            <div class="infor">â­Pontos acumulados: <span class="text-success">1.075.352</span></div>
                            <div class="infor">â­Pontos em andamento: <span class="text-info">253</span></div>
                            <div class="infor">â­Pontos que faltam: <span class="text-info">768</span></div>
                            <div class="infor">â­Pontos feitos: <span class="text-info">422</span></div>
                            <li><a href="/">Dashboard</a></li>                          
                            <li><a href="/dictionary/">DicionÃ¡rio</a></li>                   
                        </ul>
                    </div>
                    <input type="text" class="lesson-search" placeholder="ğŸ” Buscar liÃ§Ã£o">
                    <div class="bar-2">                        
                        <ul class="menu lessons">                            
                            <li><a href="#">ğŸ“‹ Lesson 1</a></li>
                            <li><a href="#">ğŸ“‹ Lesson 2</a></li>
                            <li><a href="#">ğŸ“‹ Lesson 3</a></li>                 
                        </ul>
                    </div>
                    <div class="logout">
                        <li><a href="/">Sair</a></li>
                    </div>
                </div>
            </nav>

            <main class="content">
                <div class="content-inner">
                    <div class="tittle-cont">
                        <div class="aula">                    
                            <button class="menu-toggle" aria-label="Abrir menu">
                                <img src="{% static 'chat/img/menu.png' %}" alt="Menu">
                            </button> 
                            chat
                        </div>                        
                    </div>

                    





<div class="chat-area">
  {% for line in lines %}
    <div class="chat-message {{ line.role }}"
         data-id="{{ line.id }}"
         style="display:none;">
      {{ line.content_pt|striptags }}
    </div>
  {% endfor %}
</div>

<button id="btn-start">â–¶ï¸ Iniciar liÃ§Ã£o</button>
<button id="btn-mic" disabled>ğŸ¤ Falar</button>


                  
                    <div class="footer-cont">
                        {% comment %} <button class="theme-toggle" aria-label="Trocar tema">ğŸŒ™ </button> {% endcomment %}
                         <i><strong>Â© 2026 - JPM-development - All rights reserved - Engineering & Technology</strong><i>                        
                    </div>
                    
                </div>
            </main>
        </div>
        <script src="{% static 'chat/js/script.js' %}"></script> 

        <script>
          // GARANTE QUE O AUDIO VAI SER LIDO PELA VOZ MESMO SE AINDA NAO EXISTIR
          function playWhenReady(file, tries = 30) { 
            const url = "/media/cache/" + file + "?t=" + Date.now();
            fetch(url, { method: "HEAD" })
              .then(r => {
                if (!r.ok) throw new Error("not ready");
                const a = new Audio(url);
                a.play().catch(() => {
                  if (tries > 0) setTimeout(() => playWhenReady(file, tries - 1), 150);
                });
              })
              .catch(() => {
                if (tries > 0) setTimeout(() => playWhenReady(file, tries - 1), 150);
              });
          }
        </script>




        
        <script>
  const audioPlayer = new Audio(); // ğŸ”‘ PLAYER ÃšNICO
  let fila = [];
  let tocando = false;

  function limparHTML(html) {
    return html.replace(/<[^>]+>/g, "");
  }

  function tocarFila() {
    if (tocando) return;
    if (!fila.length) return;

    tocando = true;
    audioPlayer.src = "/media/cache/" + fila.shift() + "?t=" + Date.now();

    audioPlayer.onended = () => {
      tocando = false;
      tocarFila(); // ğŸ” prÃ³ximo da sequÃªncia
    };

    audioPlayer.play();
  }

  document.addEventListener("DOMContentLoaded", function () {
    const SpeechRecognition =
      window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = "en-US";
    recognition.continuous = false;
    recognition.interimResults = false;

    const msgs = document.querySelectorAll(".chat-message");
    const btnStart = document.getElementById("btn-start");
    const btnMic = document.getElementById("btn-mic");

    let index = 0;

    msgs.forEach(m => m.style.display = "none");
    btnMic.disabled = true;

    function mostrarSistema() {
      if (index >= msgs.length) return;

      const msg = msgs[index];
      const lineId = msg.dataset.id;

      msg.innerHTML = limparHTML(msg.innerHTML);
      msg.style.display = "block";

      fetch("/tts/line/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ line_id: lineId })
      })
      .then(r => r.json())
      .then(d => {
        if (d.files && d.files.length) {
          fila.push(...d.files);
          tocarFila(); // âœ… sequÃªncia garantida
        }
      });

      btnMic.disabled = false;
    }

    // ğŸ”“ DESBLOQUEIO DE ÃUDIO AQUI (CRÃTICO)
    btnStart.onclick = function () {
      btnStart.disabled = true;

      audioPlayer.play().then(() => {
        audioPlayer.pause();
        audioPlayer.currentTime = 0;
        mostrarSistema();
      });
    };

    btnMic.onclick = function () {
      btnMic.disabled = true;
      recognition.start();
    };

    recognition.onresult = function (e) {
      const texto = e.results[0][0].transcript;
      const user = document.createElement("div");
      user.className = "chat-message user";
      user.textContent = texto;

      msgs[index].after(user);
      index++;
      mostrarSistema();
    };
  });
</script>

 
</body>
</html> 