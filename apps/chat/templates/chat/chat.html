{% load static %}
<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="{% static 'chat/css/style.css' %}">
    <meta charset="utf-8">
    <title>chat</title>
</head>
<body>

        <div class="layout">
            <nav class="sidebar">
                <div class="sidebar-inner">
                    <div class="bar-1">
                        <ul class="menu">
                            <div class="infor">üë§ Jeferson carlos Santana</div>
                            <div class="infor">‚≠êPontos acumulados: <span class="text-success">1.075.352</span></div>
                            <div class="infor">‚≠êPontos em andamento: <span class="text-info">253</span></div>
                            <div class="infor">‚≠êPontos que faltam: <span class="text-info">768</span></div>
                            <div class="infor">‚≠êPontos feitos: <span class="text-info">422</span></div>
                            <li><a href="/">Dashboard</a></li>                          
                            <li><a href="/dictionary/">Dicion√°rio</a></li>                   
                        </ul>
                    </div>
                    <input type="text" class="lesson-search" placeholder="üîç Buscar li√ß√£o">
                    <div class="bar-2">                        
                        <ul class="menu lessons">                            
                            <li><a href="#">üìã Lesson 1</a></li>
                            <li><a href="#">üìã Lesson 2</a></li>
                            <li><a href="#">üìã Lesson 3</a></li>                 
                        </ul>
                    </div>
                    <div class="logout">
                        <li><a href="/">Sair</a></li>
                    </div>
                </div>
            </nav>

            <main class="content">
                <div class="content-inner">
                    <div class="tittle-cont">
                        <div class="aula">                    
                            <button class="menu-toggle" aria-label="Abrir menu">
                                <img src="{% static 'chat/img/menu.png' %}" alt="Menu">
                            </button> 
                            chat
                        </div>                        
                    </div>

                    





<div class="chat-area">
  {% for line in lines %}
    <div class="chat-message {{ line.role }}"
        data-id="{{ line.id }}"
        data-auto="{{ line.auto|yesno:'1,0' }}"
        data-end="{{ line.end|yesno:'1,0' }}"
        data-expected="{{ line.expected_en|default:'' }}"
        style="display:none;">
      {{ line.content_pt|striptags }}
    </div>
  {% endfor %}
</div>

<button id="btn-start">‚ñ∂Ô∏è Iniciar li√ß√£o</button>
<button id="btn-mic" disabled>üé§ Falar</button>


                  
                    <div class="footer-cont">
                        {% comment %} <button class="theme-toggle" aria-label="Trocar tema">üåô </button> {% endcomment %}
                         <i><strong>¬© 2026 - JPM-development - All rights reserved - Engineering & Technology</strong><i>                        
                    </div>
                    
                </div>
            </main>
        </div>
        <script src="{% static 'chat/js/script.js' %}"></script> 

        <script>
          // GARANTE QUE O AUDIO VAI SER LIDO PELA VOZ MESMO SE AINDA NAO EXISTIR
          function playWhenReady(file, tries = 30) { 
            const url = "/media/cache/" + file + "?t=" + Date.now();
            fetch(url, { method: "HEAD" })
              .then(r => {
                if (!r.ok) throw new Error("not ready");
                const a = new Audio(url);
                a.play().catch(() => {
                  if (tries > 0) setTimeout(() => playWhenReady(file, tries - 1), 150);
                });
              })
              .catch(() => {
                if (tries > 0) setTimeout(() => playWhenReady(file, tries - 1), 150);
              });
          }
        </script>
          <script>
  // =========================
  // AUDIO ‚Äì PLAYER √öNICO
  // =========================
  const audioPlayer = new Audio();

  function limparHTML(html) {
    return html.replace(/<[^>]+>/g, "");
  }

  // =========================
  // TOCA UM √öNICO AUDIO E ESPERA
  // (IGUAL AO TTS ANTIGO)
  // =========================

function tocarUm(file, tries = 300, delay = 300) {
  return new Promise(resolve => {
    const baseUrl = "/media/cache/" + file; 
    const audioUrl = baseUrl + "?t=" + Date.now(); 

    function tentar(n) {
      fetch(baseUrl, { method: "HEAD", cache: "no-store" })
        .then(r => {
          if (!r.ok) throw new Error("not ready");

           //  LIMPA QUALQUER AUDIO EM ANDAMENTO
          audioPlayer.pause();
          audioPlayer.currentTime = 0;
          audioPlayer.onended = null;
          audioPlayer.onerror = null;

          audioPlayer.src = audioUrl;
          audioPlayer.onended = resolve;
          audioPlayer.onerror = resolve;

          audioPlayer.play().catch(resolve);
        })
        .catch(() => {
          if (n > 0) return setTimeout(() => tentar(n - 1), delay);
          resolve();
        });
    }

    tentar(tries);
  });
}



  // =========================
  // TOCA OS AUDIOS UM POR VEZ
  // (SEM FILA, SEM LISTA)
  // =========================
 let filaVoz = Promise.resolve();

function falarComoAntigo(files) {
  filaVoz = filaVoz.then(async () => {
    for (const file of files) {
      await tocarUm(file);
    }
  }).catch(() => {});

  return filaVoz;
}



function expandContractionsEn(t) {
  return (t || "")
    .replace(/\bi['‚Äô]?m\b/gi, "i am")
    .replace(/\byou['‚Äô]?re\b/gi, "you are")
    .replace(/\bhe['‚Äô]?s\b/gi, "he is")
    .replace(/\bshe['‚Äô]?s\b/gi, "she is")
    .replace(/\bit['‚Äô]?s\b/gi, "it is")
    .replace(/\bwe['‚Äô]?re\b/gi, "we are")
    .replace(/\bthey['‚Äô]?re\b/gi, "they are")
    .replace(/\bcan['‚Äô]?t\b/gi, "cannot")
    .replace(/\bdon['‚Äô]?t\b/gi, "do not");
}


function normText(s) {
  let t = (s || "").toLowerCase().replace(/[‚Äô]/g, "'");
  t = expandContractionsEn(t);     
  t = t.replace(/[^\w\s]/g, " ");
  t = t.replace(/\s+/g, " ").trim();
  return t;
}


const FEEDBACK_OK = [
  "Very good!",
  "Excellent!",
  "Perfect!",
  "Well done!",
  "Great job!"
];

const FEEDBACK_ERR = [
  "Try again.",
  "Almost, try again.",
  "Not quite right.",
  "Let's try again."
];



  document.addEventListener("DOMContentLoaded", function () {
    let lastMsgEl = null;
    // ===== SPEECH =====
    const SpeechRecognition =
      window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = "en-GB";
    recognition.continuous = false;
    recognition.interimResults = false;

    // ===== ELEMENTOS =====
    const msgs = document.querySelectorAll(".chat-message");
    const btnStart = document.getElementById("btn-start");
    const btnMic = document.getElementById("btn-mic");

    let index = 0;
    let esperandoResposta = false;
    let expectedAtual = "";
    const MAX_TENTATIVAS = 3;

  
  let tocando = false;  

    // esconde todas
    msgs.forEach(m => m.style.display = "none");
    btnMic.disabled = true;

    // =========================
    // MOSTRA FRASE + FALA
    // =========================
    function mostrarSistema() {
      if (tocando) return;
      if (index >= msgs.length) {
        btnMic.disabled = true;
        btnStart.disabled = true;
        return;
      }

  const msg = msgs[index];
  const lineId = msg.dataset.id;
  const auto = parseInt(msg.dataset.auto || "0");
  const end  = parseInt(msg.dataset.end  || "0");

  // ‚úÖ 1) APARECE AGORA
  msg.innerHTML = limparHTML(msg.innerHTML);
  msg.style.display = "block";
  lastMsgEl = msg;


  // enquanto fala, n√£o deixa mic
  btnMic.disabled = true;

   

  fetch("/tts/line/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ line_id: lineId })
  })

  
    .then(r => r.json())
    .then(async d => {


      if (d.files && d.files.length) { 
          tocando = true;
          await falarComoAntigo(d.files);
          tocando = false;
      }
      
  

    // 3) S√ì AGORA DECIDE O PR√ìXIMO PASSO
    if (end === 1) {
      btnMic.disabled = true;
      btnStart.disabled = true;
      index++;
      return;
    }

    if (auto === 1) {
      index++;
      return mostrarSistema();
    }


  esperandoResposta = true;
  expectedAtual = msg.dataset.expected || "";
  tentativas = 0;
  btnMic.disabled = false;

  });




}




    // =========================
    // BOT√ÉO INICIAR
    // =========================
    btnStart.onclick = function () {
      btnStart.disabled = true;
      index = 0;
      msgs.forEach(m => m.style.display = "none");      
      mostrarSistema();
    };

    // =========================
    // BOT√ÉO MICROFONE
    // =========================
    btnMic.onclick = function () {
      btnMic.disabled = true;
      recognition.start();
    };

    // =========================
    // RESPOSTA DO USU√ÅRIO
    // =========================
// ===== escreve avalia√ß√£o do professor =====
function escreverProfessor(text, afterEl) {
  const div = document.createElement("div");
  div.className = "chat-message system";
  div.textContent = text;
  afterEl.after(div); // mant√©m ordem: aluno ‚Üí avalia√ß√£o
  return div;
}

// ===== RESPOSTA DO USU√ÅRIO =====
// ===== RESPOSTA DO USU√ÅRIO =====
recognition.onresult = async function (e) {
  const texto = e.results[0][0].transcript;

  if (!esperandoResposta) return;

  // ===== escreve ALUNO (sempre ap√≥s a √∫ltima mensagem) =====
  const user = document.createElement("div");
  user.className = "chat-message user";
  user.textContent = texto;

  (lastMsgEl || msgs[index]).after(user);
  lastMsgEl = user;

  const expected = expectedAtual || "";
  const expectedNorms = new Set([
    normText(expected),
    normText(expandContractionsEn(expected))
  ]);
  const ok = expectedNorms.has(normText(texto));

  // bloqueia mic enquanto avalia
  btnMic.disabled = true;

  // ===== escolhe feedback =====
  const msg = ok
    ? FEEDBACK_OK[Math.floor(Math.random() * FEEDBACK_OK.length)]
    : FEEDBACK_ERR[Math.floor(Math.random() * FEEDBACK_ERR.length)];

  // ===== escreve AVALIA√á√ÉO (PROFESSOR) =====
  const prof = document.createElement("div");
  prof.className = "chat-message system";
  prof.textContent = msg;

  lastMsgEl.after(prof);
  lastMsgEl = prof;

  // para o microfone antes do feedback
  //recognition.stop();

  

  // ===== fala AVALIA√á√ÉO (bloqueante) =====
   await filaVoz;
   filaVoz = Promise.resolve();

  const r = await fetch("/tts/line/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text: msg })
  });

  .then(r => r.json())
    .then(async d => {

  const d = await r.json();
  //if (d.files && d.files.length) {     
    //for (const file of d.files) {
      //playWhenReady(file);
      //await falarComoAntigo(d.files);
    //}    
  //}

  if (d.files && d.files.length) {
      tocando = true;
       await falarComoAntigo(d.files);
      tocando = false;
  }
}
  

  // ===== decis√£o de fluxo =====
  if (ok) {
    esperandoResposta = false;
    expectedAtual = "";
    tentativas = 0;
    setTimeout(() => {
      index++;
      lastMsgEl = null;
      mostrarSistema();
    }, 600);
    return;
  }

  // errou
  tentativas++;
  if (tentativas >= MAX_TENTATIVAS) {
    esperandoResposta = false;
    expectedAtual = "";
    tentativas = 0;
    index++;
    lastMsgEl = null;
    return mostrarSistema();
  }

  // pode tentar de novo
  esperandoResposta = true;
  btnMic.disabled = false;
};





  });

  
</script>

 
</body>
</html> 