{% load static %}
<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="{% static 'chat/css/style.css' %}">
    <link rel="stylesheet" href="{% static 'chat/css/chat.css' %}">
    <link rel="stylesheet" href="{% static 'chat/css/btn.css' %}">
    <meta charset="utf-8">
    <title>chat</title>
</head>
<body> 
  <div class="layout">
    <nav class="sidebar">
      <div class="sidebar-inner">
        <div class="bar-1">
          <div class="infor">üë§ Jeferson carlos Santana</div>
          <div class="infor">‚≠êPontos acumulados: <span class="text-success">1.075.352</span></div>
          <div class="infor">‚≠êPontos em andamento: <span class="text-info">253</span></div>
          <div class="infor">‚≠êPontos que faltam: <span class="text-info">768</span></div>
          <div class="infor">‚≠êPontos feitos: <span class="text-info">422</span></div>
          <ul class="menu">  
            {% if request.user.is_superuser %}
              <li>
                <a href="/admin/">Administra√ß√£o</a>
              </li>
            {% endif %}

            <!-- <p style="color:red">
              staff={{ request.user.is_staff }} |
              super={{ request.user.is_superuser }} |
              auth={{ request.user.is_authenticated }}
            </p> -->
          
            <li><a href="/">Dashboard</a></li>                          
            <li><a href="/dictionary/">Dicion√°rio</a></li>                   
          </ul>
        </div>
        <input type="text" class="lesson-search" placeholder="üîç Buscar li√ß√£o">
        <div class="bar-2">                        
          <ul class="menu lessons">                            
            <li><a href="/chat/1/">üìã Lesson 1</a></li>
            <li><a href="/chat/2/">üìã Lesson 2</a></li>
            <li><a href="/chat/3/">üìã Lesson 3</a></li>                
          </ul>
        </div>
        <div class="logout">
          <ul class="menu"> 
            <li>
              <form method="post" action="/admin/logout/">
                {% csrf_token %}
                <button type="submit">Sair</button>
               </form>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="content">
      <div class="content-inner">
        <div class="tittle-cont">
          <div class="aula">                    
            <button class="menu-toggle" aria-label="Abrir menu">
              <img src="{% static 'chat/img/menu.png' %}" alt="Menu">
            </button> 
            chat : {{ lesson_title }} 
           
          </div>  
        
                                  
        </div>

        <div class="chat-area">
          {% for line in lines %}
          <div class="chat-message {{ line.role }}"
            data-id="{{ line.id }}"
            data-auto="{{ line.auto|yesno:'1,0' }}"
            data-end="{{ line.end|yesno:'1,0' }}"
            data-expected="{{ line.expected_en|default:'' }}"
            style="display:none;">
            {{ line.content_pt|safe }}
          </div>
          {% endfor %}
        </div>
        <div class="painel-master">
            <button class="play-madeira-velha" id="btn-start"></button>
            <button id="btnAutoSkip" class="auto-off">AUTO SKIP: OFF</button>
            <button id="btnAutoMic" class="auto-off">AUTO MIC: OFF</button> 
        </div>
        <div class="inline-input">            
            <input type="text" id="mensagem" placeholder="Digite sua resposta em ingl√™s." oncopy="return false" onpaste="return false" oncut="return false" autocomplete="off" />
           
            <button id="btnEnviar" class="btn-madeira-velha" onclick="enviarMensagem()">Enviar</button>
            <button class="btn-madeira-velha" id="btn-mic" onclick="toggleMic()">üé§</button>    
        </div>
        
        <!-- <button id="btn-mic" disabled>üé§ Falar</button> -->

        <div class="footer-cont">
          {% comment %} <button class="theme-toggle" aria-label="Trocar tema">üåô </button> {% endcomment %}
          <i><strong>¬© 2026 - JPM-development - All rights reserved - Engineering e Technology</strong></i>                        
        </div>
      </div>
    </main>
  </div>
  <script src="{% static 'chat/js/script.js' %}"></script> 

  <script>
  const USER_NAME = "{{ username|escapejs }}";
  
  function enviarMensagem() {
    const input = document.getElementById("mensagem");
    const texto = input.value.trim();
    if (!texto) return;

    input.value = "";

    window.recognition.onresult({
      results: [[{ transcript: texto }]]
    });
  }

  document.addEventListener("DOMContentLoaded", function () {       
     
      const audioPlayer = new Audio();
    
      let filaVoz = Promise.resolve();

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        console.warn("SpeechRecognition n√£o suportado neste browser");
        return; // sai do DOMContentLoaded com seguran√ßa
      }
      const recognition = new SpeechRecognition(); 
      window.recognition = recognition;
      recognition.lang = "en-GB";
      recognition.continuous = false;
      recognition.interimResults = false;

      const msgs = document.querySelectorAll(".chat-message");
      const btnStart = document.getElementById("btn-start");
      const btnMic = document.getElementById("btn-mic");
      const btnEnviar = document.getElementById("btnEnviar");

      let index = 0;
      let esperandoResposta = false;
      let expectedAtual = "";
      const MAX_TENTATIVAS = 3;  
      let tocando = false; 
      let lastMsgEl = null; 
      let lastFalandoEl = null;
      let tentativas = 0;    
      const chatArea = document.querySelector(".chat-area");
      let micTimeout = null;
      const btnAutoMic = document.getElementById("btnAutoMic");
      let autoMicAtivo = false;
      const btnAutoSkip = document.getElementById("btnAutoSkip");
      let autoSkipAtivo = false;
      const TEMPO_BASE = 5000;          // 3s m√≠nimos
      const TEMPO_POR_PALAVRA = 1000;   // 0.7s por palavra
      const TEMPO_MAX = 12000;         // 12s m√°ximo

      const beepPlayer = new Audio("/static/chat/audio/beep.mp3");
      beepPlayer.volume = 0.9;
    
      const CORRECOES_VOZ = {
        "daive": "they have",
        "dave": "they have",
        "ive": "i have",
        "youre": "you are",
        "cant": "cannot",
        "david": "they've",
        "everyday": "every day",
        "ivy": "I've",
        "hue": "He'll",
        "cole": "call",
        "gunn": "gone",
        "gunt": "gone",
        "dare": "they're",
        "81": "It won't",
        "workout": "work out",
        "seedan": "see then",
        "realized": "realised",
        "sherwood": "she would",
        "abeat": "a bit",
        "ishi": "is she",
        "taiwah": "they were",
        "Whitney": "were they",
        "alito": "a little",
        "shilco": "She'll call",
        "tay": "they",
        "iopant": "i opened",
        "ican": "i can",
        "sthey": "stay",
        "dtu": "Did you",
        "itches": "it's",
        "payen": "paying",
        "ital": "It'll",
        "leche": "Let's",
        "letis": "Let's"
      };

    function aplicarCorrecoesVoz(texto) {
      let t = texto;
      for (const errado in CORRECOES_VOZ) {
        const certo = CORRECOES_VOZ[errado];
        const re = new RegExp(`\\b${errado}\\b`, "gi");
        t = t.replace(re, certo);
      }
      return t;
    }

    btnAutoSkip.onclick = function () {
      autoSkipAtivo = !autoSkipAtivo;

      if (autoSkipAtivo) {
        btnAutoSkip.classList.remove("auto-off");
        btnAutoSkip.classList.add("auto-on");
        btnAutoSkip.textContent = "AUTO SKIP: ON";
      } else {
        btnAutoSkip.classList.remove("auto-on");
        btnAutoSkip.classList.add("auto-off");
        btnAutoSkip.textContent = "AUTO SKIP: OFF";
      }
    };

    btnAutoMic.onclick = function () {
      autoMicAtivo = !autoMicAtivo;

      if (autoMicAtivo) {
        btnAutoMic.classList.remove("auto-off");
        btnAutoMic.classList.add("auto-on");
        btnAutoMic.textContent = "AUTO MIC: ON";
      } else {
        btnAutoMic.classList.remove("auto-on");
        btnAutoMic.classList.add("auto-off");
        btnAutoMic.textContent = "AUTO MIC: OFF";
      }
    };

    function tocarBeep() {
      beepPlayer.currentTime = 0;
      beepPlayer.play().catch(() => {});
    }

    function calcularTempoMic(frase) {
      if (!frase) return TEMPO_BASE;
      const qtdPalavras = frase.trim().split(/\s+/).length;
      return Math.min(
        TEMPO_BASE + qtdPalavras * TEMPO_POR_PALAVRA,
        TEMPO_MAX
      );
    }

    function abrirMicrofoneComTempo() {
      if (btnMic.disabled) return;

      // visual de gravando
      btnMic.textContent = "üéôÔ∏è";
      btnMic.classList.add("mic-gravando");

      recognition.start();

      // calcula tempo com base na frase esperada atual
      const tempoMic = calcularTempoMic(expectedAtual);

      if (micTimeout) clearTimeout(micTimeout);

      micTimeout = setTimeout(() => {
        if (esperandoResposta) {
          // fecha mic
          try { recognition.stop(); } catch (e) {}
          btnMic.textContent = "üé§";
          btnMic.classList.remove("mic-gravando");

          // üîπ DECIS√ÉO AQUI
          if (autoSkipAtivo) {
            bloquearEntrada();

            const skip = document.createElement("div");
            skip.className = "chat-message system";
            skip.textContent = "Tempo esgotado. Avan√ßando.";
            (lastMsgEl || msgs[index]).after(skip);

            esperandoResposta = false;
            expectedAtual = "";
            tentativas = 0;

            setTimeout(() => {
              index++;
              lastMsgEl = null;
              mostrarSistema();
            }, 150);
          }
        }
      }, tempoMic);

    }

    function encerrarMicrofone() {
      if (micTimeout) {
        clearTimeout(micTimeout);
        micTimeout = null;
      }

      try {
        recognition.stop();
      } catch (e) {}

      btnMic.textContent = "üé§";
      btnMic.classList.remove("mic-gravando");
    }

    function bloquearEntrada() {
      btnMic.disabled = true;
      btnEnviar.disabled = true;

      btnMic.textContent = "üîá";
      btnMic.classList.remove("mic-ready");
      btnMic.classList.add("mic-disabled");

      btnEnviar.classList.remove("btn-ready");
      btnEnviar.classList.add("btn-disabled");
    }

    function liberarEntrada() {
      btnMic.disabled = false;
      btnEnviar.disabled = false;

      btnMic.textContent = "üé§";
      btnMic.classList.remove("mic-disabled");
      btnMic.classList.add("mic-ready");

      btnEnviar.classList.remove("btn-disabled");
      btnEnviar.classList.add("btn-ready");
    }

    function micGravando() {
      btnMic.textContent = "üéôÔ∏è";
      btnMic.classList.add("mic-gravando");
    }
    
    // GARANTE QUE O AUDIO VAI SER LIDO PELA VOZ MESMO SE AINDA NAO EXISTIR
    function playWhenReady(file, tries = 30) { 
      const url = "/media/cache/" + file + "?t=" + Date.now();
      fetch(url, { method: "HEAD" })
        .then(r => {
          if (!r.ok) throw new Error("not ready");
          const a = new Audio(url);
          a.play().catch(() => {
            if (tries > 0) setTimeout(() => playWhenReady(file, tries - 1), 150);
          });
        })
        .catch(() => {
          if (tries > 0) setTimeout(() => playWhenReady(file, tries - 1), 150);
        });
    } 

    // AUDIO ‚Äì PLAYER √öNICO     
    function limparHTML(html) {
      return html.replace(/<[^>]+>/g, "");
    }
    
    // MANTEM O CHAT EM TELA
    function scrollChatToBottom() {
      chatArea.scrollTop = chatArea.scrollHeight;
    }


    // TOCA UM √öNICO AUDIO E ESPERA
    function tocarUm(file, tries = 300, delay = 300) {
      return new Promise(resolve => {
        const baseUrl = "/media/cache/" + file; 
        const audioUrl = baseUrl + "?t=" + Date.now(); 

        function tentar(n) {
          fetch(baseUrl, { method: "HEAD", cache: "no-store" })
          .then(r => {
            if (!r.ok) throw new Error("not ready");

            // LIMPA QUALQUER AUDIO EM ANDAMENTO
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            audioPlayer.onended = null;
            audioPlayer.onerror = null;

            audioPlayer.src = audioUrl;
            audioPlayer.onended = resolve;
            audioPlayer.onerror = resolve;

            audioPlayer.play().catch(resolve);
          })
          .catch(() => {
            if (n > 0) return setTimeout(() => tentar(n - 1), delay);
            resolve();
          });
        }

        tentar(tries);
      });
    }    

    function falarComoAntigo(files) {
      filaVoz = filaVoz.then(async () => {
        for (const file of files) {
          await tocarUm(file);
        }
      }).catch(() => {});

      return filaVoz;
    }

    function expandContractionsEn(t) {
      return (t || "")
        .replace(/\bi[‚Äô']?m\b/gi, "i am")
        .replace(/\byou[‚Äô']?re\b/gi, "you are")
        .replace(/\bweren[‚Äô']?t\b/gi, "were not")
        .replace(/\bwe[‚Äô']?re\b/gi, "we are")
        .replace(/\bthey[‚Äô']?re\b/gi, "they are")
        .replace(/\bi[‚Äô']?ve\b/gi, "i have")
        .replace(/\byou[‚Äô']?ve\b/gi, "you have")
        .replace(/\bwe[‚Äô']?ve\b/gi, "we have")
        .replace(/\bthey[‚Äô']?ve\b/gi, "they have")
        .replace(/\bi[‚Äô']?ll\b/gi, "i will")
        .replace(/\byou[‚Äô']?ll\b/gi, "you will")
        .replace(/\bwe[‚Äô']?ll\b/gi, "we will")
        .replace(/\bthey[‚Äô']?ll\b/gi, "they will")
        .replace(/\bdon[‚Äô']?t\b/gi, "do not")
        .replace(/\bdoesn[‚Äô']?t\b/gi, "does not")
        .replace(/\bdidn[‚Äô']?t\b/gi, "did not")
        .replace(/\bcannot\b/gi, "can not")
        .replace(/\bwon[‚Äô']?t\b/gi, "will not")
        .replace(/\bisn[‚Äô']?t\b/gi, "is not")
        .replace(/\baren[‚Äô']?t\b/gi, "are not")        
        .replace(/\bhe[‚Äô']?s\b/gi, "he is")
        .replace(/\bshe[‚Äô']?s\b/gi, "she is")
        .replace(/\bit[‚Äô']?s\b/gi, "it is")
        .replace(/\bthat[‚Äô']?s\b/gi, "that is")
        .replace(/\bthere[‚Äô']?s\b/gi, "there is")
        .replace(/\bthere[‚Äô']?re\b/gi, "there are")
        .replace(/\bwho[‚Äô']?s\b/gi, "who is")
        .replace(/\bwhat[‚Äô']?s\b/gi, "what is")
        .replace(/\bwhere[‚Äô']?s\b/gi, "where is")
        .replace(/\bwhen[‚Äô']?s\b/gi, "when is")
        .replace(/\bhow[‚Äô']?s\b/gi, "how is")
        .replace(/\bi[‚Äô']?d\b/gi, "i had")
        .replace(/\byou[‚Äô']?d\b/gi, "you had")
        .replace(/\bhe[‚Äô']?d\b/gi, "he had")
        .replace(/\bshe[‚Äô']?d\b/gi, "she had")
        .replace(/\bwe[‚Äô']?d\b/gi, "we had")
        .replace(/\bthey[‚Äô']?d\b/gi, "they had")
        .replace(/\bcouldn[‚Äô']?t\b/gi, "could not")
        .replace(/\bshouldn[‚Äô']?t\b/gi, "should not")
        .replace(/\bwouldn[‚Äô']?t\b/gi, "would not")
        .replace(/\bmustn[‚Äô']?t\b/gi, "must not")
        .replace(/\bmayn[‚Äô']?t\b/gi, "may not")
        .replace(/\bmightn[‚Äô']?t\b/gi, "might not")
        .replace(/\bhasn[‚Äô']?t\b/gi, "has not")
        .replace(/\bhaven[‚Äô']?t\b/gi, "have not")
        .replace(/\bhadn[‚Äô']?t\b/gi, "had not")
        .replace(/\bhe[‚Äô']?ll\b/gi, "he will")
        .replace(/\bshe[‚Äô']?ll\b/gi, "she will")
        .replace(/\bit[‚Äô']?ll\b/gi, "it will")
        .replace(/\bgonna\b/gi, "going to")
        .replace(/\blet[‚Äô']?s\b/gi, "let us")

         return t;
    }

    function normEn(s) {
      let t = (s || "").toLowerCase();
      // normaliza aspas
      t = t.replace(/[‚Äô]/g, "'").replace(/[‚Äú‚Äù]/g, '"');
      // EXPANDE ANTES DE TUDO
      t = expandContractionsEn(t);
      // remove pontua√ß√£o
      t = t.replace(/[^\w\s]/g, " ");
      // normaliza espa√ßos
      t = t.replace(/\s+/g, " ").trim();
      return t;
    }


    const FEEDBACK_OK = [
      "voc√™ foi muito bem.",
      "√≥tima express√£o.",
      "extraordin√°ria resposta.",
      "voc√™ acertou.",  
      "extraordin√°rio.",     
      "√≥timo trabalho.",
      "√≥tima resposta.",
      "voc√™ falou corretamente."
    ].map(msg =>
      USER_NAME ? `${USER_NAME}, ${msg}` : msg
    );

    const FEEDBACK_ERR = [      
      "Essa ficou errada, tente novamente.",    
      "Quase l√°, tente novamente.",     
      "N√£o est√° bem certo, tente de novo.",   
      "Vamos tentar novamente.",   
      "Voc√™ cometeu um erro, tente novamente.",
      "Errar faz parte, tente de novo.",
      "Quer tentar outra vez, essa ficou errada."
    ];  

    const MSG_AVANCO = [
      "voc√™ errou, mas tudo bem, vamos continuar.",
      "n√£o tem problema se errou, vamos seguir em frente.",
      "n√£o marcou pontos, mas tudo bem, vamos em frente.",
      "voc√™ errou, sem problemas, seguimos em frente.",
      "n√£o foi dessa vez, vamos tentar a pr√≥xima."
    ].map(msg =>
      USER_NAME ? `${USER_NAME}, ${msg}` : msg
    );

      // ESCONDE TODAS
      msgs.forEach(m => m.style.display = "none");

      bloquearEntrada();      

      // MOSTRA FRASE + FALA   
      function mostrarSistema() {
        if (tocando) return;
        if (index >= msgs.length) {   
          bloquearEntrada();
          return;
        }

        const msg = msgs[index];

        if (lastFalandoEl && lastFalandoEl !== msg) {
          lastFalandoEl.classList.remove("falando");
        }
        const lineId = msg.dataset.id;
        const auto = parseInt(msg.dataset.auto || "0");
        const end  = parseInt(msg.dataset.end  || "0");      
        
        msg.style.display = "block";
        lastMsgEl = msg;
        scrollChatToBottom();
        msg.classList.add("falando");
        lastFalandoEl = msg;

        bloquearEntrada();   

        fetch("/tts/line/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ line_id: lineId })
        })

        .then(r => r.json())
        .then(async d => {

          if (d.files && d.files.length) { 
            tocando = true;
            await new Promise(r => setTimeout(r, 1500));
            await falarComoAntigo(d.files);
            tocando = false;
            tocarBeep();

            if (autoMicAtivo) {
              setTimeout(() => {
                  abrirMicrofoneComTempo();
                }, 150);
              }  
            }

          // S√ì AGORA DECIDE O PR√ìXIMO PASSO
          if (end === 1) {
            bloquearEntrada(); 
            index++;
            return;
          }

          if (auto === 1) {
            index++;
            return mostrarSistema();
          }

          esperandoResposta = true;
          expectedAtual = msg.dataset.expected || "";
          tentativas = 0;
          liberarEntrada();

        });
      }

      // BOT√ÉO INICIAR
      btnStart.onclick = function () {
        btnStart.disabled = true;
        index = 0;
        msgs.forEach(m => m.style.display = "none");      
        mostrarSistema();
      };

      // BOT√ÉO MICROFONE
      btnMic.onclick = function () {
        abrirMicrofoneComTempo();
      };

      // RESPOSTA DO USU√ÅRIO
      // ===== escreve avalia√ß√£o do professor =====
      function escreverProfessor(text, afterEl) {
        const div = document.createElement("div");
        div.className = "chat-message system";
        div.textContent = text;
        afterEl.after(div);
        return div;
      }

      // ===== RESPOSTA DO USU√ÅRIO =====
      recognition.onresult = async function (e) {
        const textoBruto = e.results[0][0].transcript;        
        if (!esperandoResposta) return;
        const textoCorrigido = aplicarCorrecoesVoz(textoBruto);
        const texto = normEn(textoBruto);        

        if (["next", "skip"].includes(texto)) {
          // corta mic imediatamente
          encerrarMicrofone();

          // bloqueia entradas
          bloquearEntrada();

          // mensagem visual opcional (recomendado)
          const skip = document.createElement("div");
          skip.className = "chat-message system";
          skip.textContent = "Frase pulada.";
          (lastMsgEl || msgs[index]).after(skip);

          // limpa estado
          esperandoResposta = false;
          expectedAtual = "";
          tentativas = 0;

          // avan√ßa para pr√≥xima frase
          setTimeout(() => {
            index++;
            lastMsgEl = null;
            mostrarSistema();
          }, 150);

          return;
        }

        encerrarMicrofone();

        bloquearEntrada(); 

        // ===== escreve ALUNO (sempre ap√≥s a √∫ltima mensagem) =====
        const user = document.createElement("div");
        user.className = "chat-message user";
        user.textContent = textoBruto;

        (lastMsgEl || msgs[index]).after(user);
        lastMsgEl = user;

        const recebido = normEn(textoCorrigido);
        const esperado = normEn(expectedAtual);

        const ok = recebido === esperado;

        // bloqueia mic enquanto avalia
        bloquearEntrada(); 

        // ===== escolhe feedback =====
        const msg = ok
        ? FEEDBACK_OK[Math.floor(Math.random() * FEEDBACK_OK.length)]
        : FEEDBACK_ERR[Math.floor(Math.random() * FEEDBACK_ERR.length)];

        // ===== monta feedback FINAL (antes de imprimir) =====
        let feedbackText = msg;
        let feedbackHTML = msg;

        const tentativaAgora = tentativas + 1;
        if (!ok) {          
          if (tentativaAgora < MAX_TENTATIVAS) {
            const expectedRaw = expectedAtual || "";
            feedbackText = `${msg} Repita comigo: ${expectedRaw}`;
            feedbackHTML = `${msg} <span class="hint">Repita comigo: <span style="color: red;">${expectedRaw}</span></span>`;
          }
        }
        
        let prof = null;      
        if (ok || tentativaAgora < MAX_TENTATIVAS) {
          prof = document.createElement("div");
          prof.className = "chat-message system";
          prof.innerHTML = feedbackHTML;

          lastMsgEl.after(prof);
          lastMsgEl = prof;
          scrollChatToBottom();
        }  

        // ===== decis√£o de fluxo =====
        if (ok) {
          if (prof) prof.classList.add("correto");
          if (prof) setTimeout(() => prof.classList.remove("correto"), 6000);
          const r = await fetch("/tts/line/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: msg, lang: "pt" })
        });  

        const d = await r.json(); 
        if (d.files && d.files.length) {
          tocando = true;
          await new Promise(r => setTimeout(r, 1100));
          await tocarUm(d.files[0]);
          tocando = false;
        }  
          esperandoResposta = false;
          expectedAtual = "";
          tentativas = 0;
          setTimeout(() => {
            index++;
            lastMsgEl = null;
            mostrarSistema();
          }, 150);
          return;
        }

        // errou
        tentativas++;
        if (prof) prof.classList.add("errado");
        if (prof) setTimeout(() => prof.classList.remove("errado"), 7000);

      if ((!ok) && (tentativas < MAX_TENTATIVAS)) {
      // ===== fala AVALIA√á√ÉO (bloqueante) =====
        const r = await fetch("/tts/line/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: feedbackText, lang: "pt" })
        });

        const d = await r.json();
        if (d.files && d.files.length) {
          tocando = true;
          await new Promise(r => setTimeout(r, 1100));
          await falarComoAntigo(d.files);
          tocando = false;

          tocarBeep();

          if (autoMicAtivo) {
            setTimeout(() => {
                abrirMicrofoneComTempo();
              }, 150);
            }  
        }
        esperandoResposta = true;
        liberarEntrada();
        return;
      }

      if (tentativas >= MAX_TENTATIVAS) {
        // mensagem de avan√ßo (SUBSTITUI o √∫ltimo "Let's try again")
        const msgAvanco = MSG_AVANCO[Math.floor(Math.random() * MSG_AVANCO.length)];

        const avanco = document.createElement("div");
        avanco.className = "chat-message system errado";
        avanco.textContent = msgAvanco;

        lastMsgEl.after(avanco);
        lastMsgEl = avanco;
        scrollChatToBottom();

        setTimeout(() => avanco.classList.remove("errado"), 8000);
        
        // fala a mensagem de avan√ßo
        const r = await fetch("/tts/line/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: msgAvanco, lang: "pt" })
        });

        const d = await r.json();
        if (d.files && d.files.length) {
          tocando = true;
          await new Promise(r => setTimeout(r, 1100));
          await tocarUm(d.files[0]);
          tocando = false;
        }

        // reseta e avan√ßa
        esperandoResposta = false;
        expectedAtual = "";
        tentativas = 0;
        index++;
        lastMsgEl = null;
        return mostrarSistema();
      }


        // pode tentar de novo
        esperandoResposta = true;
        liberarEntrada();        
      };       
      
    });
    
  </script>
</body>
</html> 